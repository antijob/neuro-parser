# Developer Guide

This document contains instructions for developers, including Python package management, local and production deployment, Telegram bot setup, message broadcasting, and API usage.

## Python Package Management

We use [PDM](https://pdm-project.org/) for Python package management:

```bash
# install all pinned packages from the lock file
pdm install

# resolve all dependencies and lock the packages in a lock file
pdm lock

# update all packages
pdm update

# add a new package to pyproject.toml without creating a venv
pdm add --no-sync <package_name>
```

The `pyproject.toml` and `pdm.lock` files should be included in git.

---

## Local Deployment

1. Create a `.env` file based on `.env.template` and initialize the database.
2. Run the following command in the root directory to start the local container:

```bash
docker-compose up -d
```

3. Add the following lines to the `/etc/hosts` file to resolve local Traefik domains:

```bash
127.0.0.1 report.local
127.0.0.1 flower-report.local
```

4. Access the admin panel at `http://report.local/s/ecret/admin` or use the API: `http://report.local/api`.

5. To fully operate the system, add links to sources and incident types for tracking.

---

## Production Deployment

1. Modify the `config/.env` file and create the database.
2. Run the following command in the root directory to start the container in production:

```bash
docker-compose -f docker-compose.prod.yaml up -d
```

---

## Telegram Bot Setup

You can use the Telegram bot to receive notifications about new incidents.

### Setup

1. Register a new bot through [BotFather](https://t.me/BotFather).
2. Add the following settings to the `.env` file:

```bash
TELEGRAM_BOT_TOKEN=
```

- `TELEGRAM_BOT_TOKEN` - Token issued by BotFather.

3. Create a new chat in Telegram, add the bot, and it will remember it and send notifications about new incidents there.
4. To receive notifications only for certain categories, use the `/categ` command in the chat.
5. You can also manage channels through the Django admin panel in the Bot section.

---

## Model API

We use [Replicate.com](https://replicate.com/) for calling external models, a cheaper alternative to ChatGPT.

---

## REST API Interface

Built on `django-rest-api-framework`, documentation is automatically generated by swagger and available at `/swagger-ui`.

---

## Infrastructure

Two remote machines were created for the `stage` and `prod` environments. They are set up identically, and the server is started the same way as locally:

```
docker compose -f docker-compose.prod.yaml pull
docker-compose -f docker-compose.prod.yaml -d
```

More detailed deployment process can be seen in [deploy.yml](.github/workflows/deploy.yml).

> [!NOTE] Note
> The working directory on servers where the running version of the server is located: `/opt/services/neuro-parser`. 
> Current information about where the server is running is located in `$DEPLOY_LOCATION` in the [deploy.yml](.github/workflows/deploy.yml) file.

> [!WARNING] Important! 
> The `github-actions` working directory (`/home/github-actions/_work/neuro-parser`) is used only for cloning the repository.
> The project is not and should not be run there.

---

## Telethon Client Configuration

To work with Telegram channels through Telethon, follow these steps:

1. Obtain API keys at [my.telegram.org/apps](https://my.telegram.org/apps).
2. Add the keys to the `.env` file:

```bash
TELEGRAM_API_ID=
TELEGRAM_API_HASH=
```

- `TELEGRAM_API_ID` — your API ID.
- `TELEGRAM_API_HASH` — your API Hash.

3. Run the following Django command to authorize in Telegram:

```bash
python manage.py init_telethon_client
```

4. After authorization, add the Telegram source through the Django admin panel. If it's a private channel, check the corresponding box `[v] private Telegram channel`.

> Note: You can use Telethon for both private channels (authorization required) and public ones.

---

### Common Operations on Servers

- **There is an error in the environment (`stage` or `prod`), need to read the logs**
  
  ```bash
  # read logs from a specific container
  # web - server (admin panel), bot - TG bot, celery - queue tasks
  docker logs neuro-parser-web-1
  # or
  cd /opt/services/neuro-parser
  docker-compose -f docker-compose.prod.yml logs -f
  ```

- **Need to test a script inside the container**
  
  ```bash
  # web - server (admin panel), bot - TG bot, celery - queue tasks
  docker exec -it neuro-parser-web-1 bash
  # or
  cd /opt/services/neuro-parser
  docker-compose -f docker-compose.prod.yml exec -it web bash
  ```

- **Ran out of space. Server spams `No space left on disk` errors.**

  It's likely that space ran out due to constant building or downloading of images. They should be periodically cleaned, but in rare cases, this may not be enough. You can try to clean up space manually:

  ```bash
  docker container prune -f
  docker image prune -af
  # check disk space
  df -h
  ```

---

## Contribution

We welcome community participation. Please follow the instructions in the [CONTRIBUTING.md](https://github.com/antijob/neuro-parser/blob/main/CONTRIBUTING.md) file.

---

## Contacts

If you have any questions or need help, contact us at info@antijob.net.

