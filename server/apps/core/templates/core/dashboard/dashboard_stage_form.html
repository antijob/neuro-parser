{% load static %}

<div id="stage-modal" class="modal">
  <h6 id="stage-header">Редактирование этапа</h6>
  <form id="stage-form" class="card-body form" method="post">{% csrf_token %}
    <div class="form-group">
      <label>Заголовок</label>
        {{ form.title }}
    </div>
    <div class="form-group">
      <label>Текст карточки</label>
        {{ form.summary }}
    </div>
    <div class="form-group">
      <label>Текст</label><br>
      {{ form.text }}
    </div>
    <button type="submit" rel="modal:close" class="btn btn-primary">Сохранить</button>
    <a href="#" rel="modal:close" class="cancel btn btn-danger">Отмена</a>
  </form>

  <script type="text/javascript">
    $("#stage-form").submit(function(e) {
      e.preventDefault();
      let form = $(this);
      {% if object %}
        let url = "/dashboard/campaign/{{ campaign_pk }}/stage/{{ object.pk }}/update/";
      {% else %}
        let url = "/dashboard/campaign/{{ campaign_pk }}/stage/create/";
      {% endif %}
      let title = $("#id_title").val();
      let summary = $("#id_summary").val();
      let text = CKEDITOR.instances["id_text"].getData();
      let campaign_pk = "{{ campaign_pk }}";
      let data = {"title": title, "summary": summary, "text": text}
      $.ajax({
        type: "POST",
        url: url,
        data: data,
        success: function() {
          let title = $("#stage-form input[name=title]").val()
          let summary = $("#stage-form textarea[name=summary]").val()
          {% if object %}
            $("#stage-{{ object.pk }} .stage-title").text(title)
            $("#stage-{{ object.pk }} .stage-summary").text(summary)
            $.modal.close();
          {% else %}
            location.reload();
          {% endif %}
        }
      });
    });
  </script>
</div>
