{% extends 'core/dashboard/layout.html' %}

{% load static %}

{% block container %}


  {% include "core/dashboard/dashboard_stat_blocks.html" %}

  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">{{ table_title }}</h6>
    </div>

    <div class="card-body">
      <p>
        <strong class="text-lg text-dark mr-5">
          Всего заявок: {{ incidents_count }}
        </strong>
        <a
          class="btn btn-small btn-outline-success"
          href="{% url 'core:dashboard-campaign-incidents-export' campaign.pk %}"
          target="_blank"
        >
          Экспорт данных кампании
        </a>
      </p>

      <div class="input-group mb-3 row">
        <span class="col-xl-8 col-lg-8 col-md-12">
          <input id="table-search" type="text" class="form-control" placeholder="Поиск...">
        </span>

        <span class="col-xl-4 col-lg-4 col-md-12">
          <input id="dates" type="email" name="dates" class="form-control" autocomplete="off" placeholder="Даты">
        </span>
        <input type="hidden" id="start_date">
        <input type="hidden" id="end_date">
      </div>

      <div class="table-responsive">
        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
        </table>
      </div>
    </div>
  </div>

{% endblock %}

{% block dashboard_scripts %}
<script src="{% static 'core/datepicker/js/bootstrap-datepicker.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'core/datepicker/css/bootstrap-datepicker3.min.css' %}">
<script src="{% static 'core/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'core/js/dataTables.bootstrap4.min.js' %}"></script>
<script type="text/javascript">
const DATA_URL = "data/";
const COLUMNS = [
  {data: 'email', width: "50%", title: "Заголовок"},
  {data: 'status', width: "7%", title: "Статус"},
  {data: 'create_date', width: "7%", title: "Дата создания"},
];

const COLUMN_DEFS = [
  {
    render: function ( data, type, row ) {
      let icon = "<i class='fas fa-user mr-2 text-secondary' title='Инцидент по заявке'></i>";
      return "<a href='/dashboard/incident/" + row["pk"] + "/update/'><div class='row-title p-2'>" + icon + data + "</div></a>";
    },
    targets: 0
  },
  {
    render: function ( data, type, row ) {
      badgeClass = ['danger', 'white', 'success', 'warning', 'warning', 'secondary'][data];
      badgeText = ['Не обработан', 'Отклонен', 'Принят', 'Коммуникации', 'В работе', 'Завершен', 'Удален'][data];
      td = '<span class="badge status-badge badge-' + badgeClass + '">' + badgeText + '</span>';
      return td;
    },
    targets: 1
  },
];

function getCookie(name) {
  var cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
      var cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function csrfSafeMethod(method) { return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method)) }
$.ajaxSetup({
  beforeSend: function(xhr, settings) {
    var csrftoken = getCookie("csrftoken");
    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
    }
  }
});


$(document).ready(function () {
  tableApi = $('#dataTable').DataTable({
    dom: "Brtip",
    ajax: {
      url: DATA_URL,
      data: function ( d ) {
        d = Object.assign(d, {});
        d.start_date = $("#start_date").val();
        d.end_date = $("#end_date").val();
      },
    },
    serverSide: true,
    info: false,
    pageLength: 12,
    bSort: false,
    columns: COLUMNS,
    columnDefs: COLUMN_DEFS,
    sPaginationType: "full_numbers",
    createdRow: function (row, data, dataIndex) {
      $(row).addClass('data-row');
    },
    language: {
      paginate: {
        next: 'Вперед',
        previous: "Назад",
        first: '&laquo;',
        last: '&raquo;'
      },
    },
  });

  searchTimeout = null;
  $('#table-search').keyup(function () {
    let query = $(this).val();
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function () {
      tableApi.search(query).draw();
    },
    1000);
  });


  let ranges = {
        'Этот месяц': [moment().startOf('month'), moment().endOf('month')],
        'Предыдущий месяц': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
        'За всё время': [moment([2015, 0, 1]), moment()],
  }
  for (year=2015; year <= new Date().getFullYear(); year++) {
    ranges[year] = [moment([year, 0, 1]), moment([year, 11, 31])]
  }
  datePicker = $('#dates').daterangepicker({
    ranges: ranges,
    locale: {
        "format": "DD.MM.YYYY",
        "separator": " - ",
        "applyLabel": "Принять",
        "cancelLabel": "Отмена",
        "fromLabel": "С",
        "toLabel": "до",
        "customRangeLabel": "Выбрать свои даты",
        "weekLabel": "Нед",
        "daysOfWeek": [
            "Вс",
            "Пн",
            "Вт",
            "Ср",
            "Чт",
            "Пт",
            "Сб"
        ],
        "monthNames": [
            "Январь",
            "Февраль",
            "Март",
            "Апрель",
            "Май",
            "Июнь",
            "Июль",
            "Август",
            "Сентябрь",
            "Октябрь",
            "Ноябрь",
            "Декабрь"
        ],
        "firstDay": 1
    },
    autoUpdateInput: false,
    autoApply: true,
  });

  $('#dates').on('apply.daterangepicker', function(ev, picker) {
    start_date = picker.startDate.format('YYYY-MM-DD');
    end_date = picker.endDate.format('YYYY-MM-DD');
    $("#start_date").val(start_date);
    $("#end_date").val(end_date);
    $('#dates').val(picker.startDate.format('DD.MM.YYYY') + ' - ' + picker.endDate.format('DD.MM.YYYY'));
    tableApi.draw();
  });

  $('#dates').on('cancel.daterangepicker', function(ev, picker) {
    $("#start_date").val(null);
    $("#end_date").val(null);
    $('#dates').val('');
    tableApi.draw();
  });
});

</script>
{% endblock %}
