{% extends 'core/dashboard/layout.html' %}

{% load i18n %}
{% load static %}

{% block container %}
  <!-- Page Heading -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Панель управления</h1>
  </div>


  {% include "core/dashboard/dashboard_stat_blocks.html" %}

  <!-- Content Row -->
  <div class="row">

    <!-- Content Column -->
    <div class="col-lg-6 mb-4">

      <!-- Project Card Example -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Необработанные инциденты по заявкам</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered" id="tableUser" width="100%" cellspacing="0">
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="col-lg-6 mb-4">

      <!-- Illustrations -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">Необработанные инциденты из СМИ</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered" id="tableMedia" width="100%" cellspacing="0">
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

{% endblock %}

{% block dashboard_scripts %}
  <script src="{% static 'core/js/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'core/js/dataTables.bootstrap4.min.js' %}"></script>
  <script>
    $(document).ready(function () {
      let settingsDefault = {
        dom: "rtp",
        ajax: {
          url: "{% url 'core:dashboard-incidents-data' %}",
        },
        serverSide: true,
        info: false,
        pageLength: 12,
        bSort: false,
        sPaginationType: "full_numbers",
        columns: [
          {data: 'any_title', width: "80%", title: "Заголовок"},
          {data: 'status'},
          {data: 'create_date', width: "20%", title: "Дата создания"},
          {data: 'is_media'},
          {data: 'pk'},
        ],
        language: {
          paginate: {
            next: 'Вперед',
            previous: "Назад",
            first: '&laquo;',
            last: '&raquo;'
          },
        },
        columnDefs: [
            {
              render: function ( data, type, row ) {
                if (row['is_media']){
                  td = "<a href=\"/dashboard/mediaincident/" + row['pk'] + "/update/\" ><i class=\"fas fa-newspaper mr-2 text-secondary\" title='Инцидент из СМИ'></i> "
                } else {
                  td = "<a href=\"/dashboard/incident/" + row['pk'] + "/update/\" ><i class=\"fas fa-user mr-2 text-secondary\" title='Инцидент по заявке'></i> "
                }
                return td + data;
              },
              targets: 0
            },
            {
                "targets": [1, 3, 4],
                "visible": false
            },
        ]
      };

      let settingsUser = settingsDefault;
      let settingsMedia = Object.assign({}, settingsDefault); // copy settings

      let unprocessedData = function (data) {
        data.status_code = 0
        data.userincidents_only = 1;
        data.mediaincidents_only = 0;
      };
      settingsUser.ajax.data = unprocessedData;
      $('#tableUser').DataTable(settingsUser);

      let unprocessedMediaData = function (data) {
        data.status_code = 0;
        data.userincidents_only = 0;
        data.mediaincidents_only = 1;
      };
      settingsMedia.ajax.data = unprocessedMediaData;
      $('#tableMedia').DataTable(settingsMedia);

      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      });
    });
  </script>
{% endblock %}
